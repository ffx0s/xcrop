!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Crop=e()}(this,function(){"use strict";function t(){}function e(t,e){function n(n){var i=arguments.length;return i?i>1?t.apply(e,arguments):t.call(e,n):t.call(e)}return n._length=t.length,n}function n(t,e){for(var n in e)t[n]=e[n];return t}function i(t){var e=void 0;e=t.split(",")[0].indexOf("base64")>=0?window.atob(t.split(",")[1]):unescape(t.split(",")[1]);for(var n=t.split(",")[0].split(":")[1].split(";")[0],i=new ArrayBuffer(e.length),o=new Uint8Array(i),a=0;a<e.length;a++)o[a]=e.charCodeAt(a);var r=void 0;try{r=new window.Blob([i],{type:n})}catch(t){if(window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,"TypeError"===t.name&&window.BlobBuilder){var c=new window.BlobBuilder;c.append(o.buffer),r=c.getBlob(n)}else"InvalidStateError"===t.name&&(r=new window.Blob([i],{type:n}))}return r}function o(t,e){var n=new window.XMLHttpRequest;n.open("GET",t,!0),n.responseType="blob",n.onload=function(t){200!==this.status&&0!==this.status||e(this.response)},n.send()}function a(t,e){var n=new window.XMLHttpRequest;n.onload=function(){if(200!==this.status&&0!==this.status)throw new Error("Could not load image");e(n.response),n=null},n.open("GET",t,!0),n.responseType="arraybuffer",n.send(null)}function r(t,e){var n=document.createElement("canvas"),i=n.getContext("2d"),o=t.width,a=t.height;return n.width=o*e,n.height=a*e,i.drawImage(t,0,0,o,a,0,0,n.width,n.height),n}function c(t,e){var n=document.createElement("canvas"),i=n.getContext("2d"),o=t.getContext("2d"),a=t.width,r=t.height,c=a*e,s=r*e;n.width=c,n.height=s;for(var h=Math.ceil(Math.log(a/c)/Math.log(2)),l=0;l<h;l++)o.drawImage(t,0,0,.5*a,.5*r);return i.drawImage(t,0,0,t.width*Math.pow(.5,h),t.height*Math.pow(.5,h),0,0,c,s),n}function s(t){var e=new DataView(t);if(65496!==e.getUint16(0,!1))return-2;for(var n=e.byteLength,i=2;i<n;){var o=e.getUint16(i,!1);if(i+=2,65505===o){if(1165519206!==e.getUint32(i+=2,!1))return-1;var a=18761===e.getUint16(i+=6,!1);i+=e.getUint32(i+4,a);var r=e.getUint16(i,a);i+=2;for(var c=0;c<r;c++)if(274===e.getUint16(i+12*c,a))return e.getUint16(i+12*c+8,a)}else{if(65280!=(65280&o))break;i+=e.getUint16(i,!1)}}return-1}function h(t,e,n,i){var o=new window.Image;R(t)||(o.crossOrigin="*"),o.onload=function(){var t=o.width,a=o.height,r=document.createElement("canvas"),c=r.getContext("2d");if(!!navigator.userAgent.match(/AppleWebKit.*Mobile.*/)&&t*a>16777216){var s="Canvas area exceeds the maximum limit (width * height > 16777216)";return console.warn(s),void(i?i({code:1,message:s}):window.alert(s))}l(r,c,t,a,e),c.drawImage(o,0,0),n(r)},o.src=t}function l(t,e,n,i,o){switch([5,6,7,8].indexOf(o)>-1?(t.width=i,t.height=n):(t.width=n,t.height=i),o){case 2:e.transform(-1,0,0,1,n,0);break;case 3:e.transform(-1,0,0,-1,n,i);break;case 4:e.transform(1,0,0,-1,0,i);break;case 5:e.transform(0,1,1,0,0,0);break;case 6:e.transform(0,1,-1,0,i,0);break;case 7:e.transform(0,-1,-1,0,i,n);break;case 8:e.transform(0,-1,1,0,0,n);break;default:e.transform(1,0,0,1,0,0)}}function u(t,e,n,i){var o=t/e,a=n,r=a/o,c=0,s=-(r-i)/2;return r<i&&(r=i,a=o*r,c=-(a-n)/2,s=0),{width:a,height:r,x:c,y:s}}function d(t,e,n){function r(t,i){var o=s(t);h("string"!=typeof i?window.URL.createObjectURL(i):i,o,e,n)}function c(t){var e=new window.FileReader;e.onload=function(e){r(e.target.result,t)},e.readAsArrayBuffer(t)}return window.FileReader&&(t instanceof window.Blob||t instanceof window.File)?void c(t):"object"===(void 0===t?"undefined":U(t))&&t.nodeType?("IMG"===t.tagName&&d(t.src,e),void("CANVAS"===t.tagName&&e(t))):R(t)?void c(i(t)):void(z(t)?o(t,c):a(t,function(e){r(e,t)}))}function f(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];for(var i in e)this[i]=e[i];this.tagName=t,this.children=n}function v(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t;if("string"==typeof e){var i=document.createTextNode(e);return n(e),i}var o=e.create();return e.children.forEach(function(t){var e=v(t,n);o.appendChild(e)}),n(e),o}function m(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];"string"!=typeof t&&(t.children.forEach(function(t){m(t,e,!1)}),t.removeEvent(),n&&e.removeChild(t.el))}function p(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document.getElementsByTagName("head")[0],n=document.createElement("style");try{n.appendChild(document.createTextNode(t))}catch(e){n.stylesheet.cssText=t}return e.appendChild(n),n}function g(){this.events={}}function w(t,e){var n=[];for(var i in t)"number"!=typeof+i||isNaN(+i)||n.push(e(t[i],i));return n}function y(t){t.eventList=["mousewheel","touchstart","touchmove","touchend"],t.isMove=!1,t.isLock=!1,t.observer=new g}function x(t){var e=t.options.touchTarget||t.canvas;t.eventList.forEach(function(n){e.addEventListener(n,t,!1)})}function b(t){t.scale=1,t.lastScale=1,t.origin={x:0,y:0}}function S(t){var e=t.options;e.el="string"==typeof e.el?document.querySelector(e.el):e.el,t.canvas=t.createCanvas(),t.context=t.canvas.getContext("2d"),function(n){var i=t.createCanvas();e.el.appendChild(i),setTimeout(function(){var t=i.getBoundingClientRect();e.el.removeChild(i),i=null,n(t)},10)}(function(n){t.rect=n,t.canvasScale=e.width/t.rect.width,t.load(e.target,function(){e.el.appendChild(t.canvas)})})}function E(t,e){return t+e}function T(t){return{x:t.map(function(t){return t.x}).reduce(E)/t.length,y:t.map(function(t){return t.y}).reduce(E)/t.length}}function C(t,e,n){n=n||["x","y"];var i=e[n[0]]-t[n[0]],o=e[n[1]]-t[n[1]];return Math.sqrt(i*i+o*o)}function M(t,e){return C(e[0],e[1])/C(t[0],t[1])}function k(){return{target:null,el:null,width:800,height:800,maxScale:2,minScale:1,touchTarget:null,offset:{left:0,right:0,top:0,bottom:0},loaded:t}}function N(t,e){e.el=t,this.init(e)}function B(){return{target:null,el:null,width:300,height:300,x:void 0,y:void 0,maxScale:2,minScale:1,canvasScale:2,touchTarget:null,created:t,mounted:t,loaded:t,cancle:t,confirm:t}}function L(t){this.init(t)}function A(t){return"crop-"+t}var z=function(t){return/^blob:/i.test(t)},U="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},R=function(t){return t.indexOf(";base64,")>0};f.prototype={create:function(){return this.el=document.createElement(this.tagName),this.el.className=this.className,this.addEvent(),this.el}},["addEvent","removeEvent"].forEach(function(t){f.prototype[t]=function(){for(var e in this.events)this.el[t+"Listener"](e,this.events[e],!1)}});var q=Array.prototype.slice;g.prototype={on:function(t,e){var n=this;t.split(" ").forEach(function(t){n.events[t]||(n.events[t]=[]),e&&n.events[t].push(e)})},emit:function(t){var e=this,n=q.call(arguments,1);t=t.split(" ").forEach(function(t){var i=e.events[t];i&&i.forEach(function(t){return t.apply(e,n)})})},off:function(t,e){var n=this,i=n.events[t];i&&i.forEach(function(t){return i.splice(i.indexOf(t),1)})}};var I={easeOut:function(t,e,n,i){return-n*(t/=i)*(t-2)+e}},O=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)}}(),F=function(){return window.cancelAnimationFrame||window.mozCancelAnimationFrame||function(t){clearTimeout(t)}}(),D=function(){return(new Date).getTime()},X=function(t){function e(){var t=D(),n=1-Math.max(0,h-t+i)/i,o=[];r.forEach(function(t){o.push(I[a](n*i,t[0],t[1]-t[0],i))}),c(o),1===n?(F(c.timer),s&&s()):O(e)}var n=t.times,i=void 0===n?500:n,o=t.type,a=void 0===o?"easeOut":o,r=t.targets,c=t.animate,s=t.end,h=D();F(c.timer),c.timer=O(e)};return N.prototype.init=function(t){var e=this;e.options=n(k(),t),function(t){y(t),b(t)}(e),S(e),x(e)},function(t){t.getTouchCenter=T,t.getDistance=C,t.getScale=M,t.Observer=g}(N),function(t){var n=t.prototype;n.handleEvent=function(t){var e=this;switch(t.type){case"touchstart":e.touchstart(t);break;case"touchmove":e.touchmove(t);break;case"touchend":e.touchend(t);break;case"mousewheel":e.mousewheel(t)}},n.mousewheel=function(t){t.preventDefault();var e=this,n={x:t.clientX-e.rect.left,y:t.clientY-e.rect.top},i=t.wheelDelta/520,o=Math.exp(.01*i);e.scaleTo(n,o),e.validation(),e.emit("mousewheel",t)},n.touchstart=function(t){t.preventDefault();var e=this,n=t.touches;if(e.isLock)return!1;2===n.length?e.pinchstart(t):1===n.length&&e.dragstart(t),e.isMove=!0},n.touchmove=function(t){var e=this,n=t.touches;if(!e.isMove||e.isLock)return!1;2===n.length?e.pinchmove(t):1===n.length&&e.dragmove(t)},n.touchend=function(t){var e=this;if(e.isLock)return!1;e.isMove=!1,e.validation(),e.emit("touchend",t)},n.dragstart=function(t){var e=this,n=t.touches;e.dragStart={x:n[0].pageX-e.rect.left,y:n[0].pageY-e.rect.top},e.lastMove={x:e.position.x-e.origin.x,y:e.position.y-e.origin.y},e.emit("touchstart",t)},n.dragmove=function(t){var e=this,n=t.touches,i={x:n[0].pageX-e.rect.left-e.dragStart.x,y:n[0].pageY-e.rect.top-e.dragStart.y},o=e.canvasScale/e.scale,a=e.lastMove.x+i.x*o,r=e.lastMove.y+i.y*o;e.moveTo(a,r),e.emit("touchmove",t)},n.pinchstart=function(t){var e=this;e.zoomStart=w(t.touches,function(t){return{x:t.pageX,y:t.pageY}}),e.zoomCount=0,e.emit("pinchstart",t)},n.pinchmove=function(e){var n=this;if(!n.isMove)return!1;n.zoomCount++,n.zoomEnd=w(e.touches,function(t){return{x:t.pageX,y:t.pageY}});var i=t.getTouchCenter(n.zoomEnd),o=t.getScale(n.zoomStart,n.zoomEnd);if(n.zoomCount<=2)return n.lastScale=o,!1;var a=1+o-n.lastScale,r={x:i.x-n.rect.left,y:i.y-n.rect.top};n.scaleTo(r,a),n.lastScale=o,n.emit("pinchmove",e)},n.emit=function(t){this.observer.emit.apply(this.observer,arguments)},["on","off"].forEach(function(t){n[t]=function(n,i){this.observer[t](n,i&&e(i,this))}})}(N),function(t){var e=t.prototype;e.createCanvas=function(){var t=this,e=document.createElement("canvas");return e.width=t.options.width,e.height=t.options.height,e.style.cssText="width:100%;height:100%;",e},e.load=function(t,e){function n(t){var n=i.options,o=n.width,a=n.height,r=n.offset,c=n.loaded,s=i.canvasScale,h=o-(r.left+r.right)*s,l=a-(r.top+r.bottom)*s;i.position=u(t.width,t.height,h,l),i.position.x+=r.left*s,i.position.y+=r.top*s,i.imageCanvas=t,i.draw(),e&&e(),c.call(i)}var i=this;d(t,n)},e.remove=function(){var t=this,e=t.options.touchTarget||t.canvas;t.eventList.forEach(function(n){e.removeEventListener(n,t,!1)}),t.options.el.removeChild(t.canvas)},e.draw=function(){var t=this,e=t.options,n=t.context,i=t.position,o=i.x,a=i.y,r=i.width,c=i.height;n.save(),n.setTransform(1,0,0,1,0,0),n.clearRect(0,0,e.width,e.height),n.restore(),n.drawImage(t.imageCanvas,o,a,r,c)},e.moveTo=function(t,e){var n=this,i=t-(n.position.x-n.origin.x),o=e-(n.position.y-n.origin.y);n.context.translate(i,o),n.origin.x-=i,n.origin.y-=o,n.draw()},e.scaleTo=function(t,e){var n=this,i=n.context,o=n.canvasScale,a=n.scale,r=n.origin;if(e>1&&!n.vaildMaxScale()||e<1&&!n.vaildMinScale())return!1;n.vaildMaxScale(a*e)?n.vaildMinScale(a*e)||(e=n.options.minScale/a):e=n.options.maxScale/a,i.translate(r.x,r.y),n.origin.x-=t.x*o/(a*e)-t.x*o/a,n.origin.y-=t.y*o/(a*e)-t.y*o/a,i.scale(e,e),i.translate(-n.origin.x,-n.origin.y),n.scale*=e,n.draw()}}(N),function(t){var n=t.prototype;n.validation=function(){function t(){n.lastAnimate={x:0,y:0}}var n=this,i=n.options,o=n.position,a=n.scale,r=(o.x-n.origin.x)*a,c=(o.y-n.origin.y)*a,s=i.offset,h=s.left,l=s.right,u=s.top,d=s.bottom,f=n.canvasScale,v=h*f,m=u*f,p=i.width-(h+l)*f-(o.width*a-(v-r)),g=i.height-(u+d)*f-(o.height*a-(m-c)),w=0,y=0,x=!1;r>=v?(w=-(r-v)/a,n.origin.x-=w,x=!0):p>0&&(w=p/a,n.origin.x-=w,x=!0),c>=m?(y=-(c-m)/a,n.origin.y-=y,x=!0):g>0&&(y=g/a,n.origin.y-=y,x=!0),x&&(t(),X({targets:[[0,w],[0,y]],times:150,animate:e(n._animate,n),end:function(){n.isLock=!1,t()}}))},n.vaildMaxScale=function(t){return(t||this.scale)<this.options.maxScale},n.vaildMinScale=function(t){return(t||this.scale)>this.options.minScale},n._animate=function(t){var e=this,n=e.lastAnimate;e.isLock=!0,e.context.translate(t[0]-n.x,t[1]-n.y),e.draw(),e.lastAnimate={x:t[0],y:t[1]}}}(N),L.prototype={init:function(t){var e=this;e.options=n(B(),t),e.create(),e.render(),L.count++},create:function(){var t=this,n=t.options,i=n.el;n.el=i?"string"==typeof i?document.querySelector(i):i:document.body;var o=[],a=n.width,r=n.height,c=document.documentElement,s={className:A("wrap"),width:i?i.offsetWidth:c.clientWidth,height:i?i.offsetHeight:c.clientHeight,style:function(){return"\n          ."+this.className+" {\n            position: fixed;\n            left: 0;\n            top: 0;\n            overflow: hidden;\n            width: "+this.width+"px;\n            height: "+this.height+"px;\n            background: #000;\n            z-index: 99;\n          }\n        "}},h={className:A("mask"),left:"number"==typeof n.x?n.x-s.width:-(a+s.width)/2,top:"number"==typeof n.y?n.y-s.height:-(r+s.height)/2,style:function(){return"\n          ."+this.className+" {\n            position: absolute; \n            left: "+this.left+"px;\n            top: "+this.top+"px;\n            width: "+a+"px; \n            height: "+r+"px; \n            overflow: hidden;\n            border: 1px solid rgba(0, 0, 0, .6);\n            border-width: "+s.height+"px "+s.width+"px;\n            box-sizing: content-box;\n          }\n          ."+this.className+":after {\n            position: absolute;\n            left: 0;\n            top: 0;\n            float: left;\n            content: '';\n            width: 200%;\n            height: 200%;\n            border: 1px solid #fff;\n            -webkit-box-sizing: border-box;\n            box-sizing: border-box;\n            -webkit-transform: scale(0.5);\n            transform: scale(0.5);\n            -webkit-transform-origin: 0 0;\n            transform-origin: 0 0;\n          }\n        "}},l={className:A("handle"),style:function(){return"\n          ."+this.className+" {\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            width: 100%;\n            height: 50px;\n            line-height: 50px;\n            background-color: rgba(0,0,0,.3);\n          }\n          ."+this.className+" > div {\n            height: 100px;\n            width: 80px;\n            color: #fff;\n            font-size: 16px;\n            text-align: center;\n          }\n        "}},u={className:A("cancle"),style:function(){return"\n          ."+this.className+" {\n            float: left;\n          }\n        "},events:{touchstart:e(n.cancle,t)}},d={className:A("confirm"),style:function(){return"\n          ."+this.className+" {\n            float: right;\n          }\n        "},events:{touchstart:e(n.confirm,t)}};t.root=new f("div",s,[new f("div",h),new f("div",l,[new f("div",u,["取消"]),new f("div",d,["确认"])])]),v(t.root,function(t){t.style&&o.push(t.style())}),t.styles=o.join(""),t.area={width:a,height:r},n.x=s.width+h.left,n.y=s.height+h.top,n.created.call(t)},render:function(){var t=this,n=t.options;0===L.count&&p(t.styles),n.el.appendChild(t.root.el),t.initPinch(),setTimeout(e(n.mounted,t),0)},initPinch:function(){function t(){var t=e.options,n=t.target,i=t.canvasScale,o=t.x,a=t.y,r=t.el,c=t.maxScale,s=t.minScale,h=t.loaded,l=e.root,u=l.el,d=l.width,f=l.height,v={target:n,el:r,maxScale:c,minScale:s,loaded:h,width:d*i,height:f*i,touchTarget:u,offset:{left:o,right:d-e.area.width-o,top:a,bottom:f-e.area.height-a}};e.pinch=new N(u,v)}var e=this;setTimeout(t,0)},get:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=this,o=e.pinch,a={width:void 0,height:void 0,type:"image/jpeg",quality:.85},s=n(a,t),h=s.width,l=s.height,u=s.type,d=s.quality,f=o.options.offset,v=f.left,m=f.top,p=o.options.width/o.rect.width,g=v*p,w=m*p,y=e.area.width*p,x=e.area.height*p,b=document.createElement("canvas"),S=b.getContext("2d");b.width=y,b.height=x,S.drawImage(o.canvas,g,w,y,x,0,0,y,x);var E={},T=h||l;if(T){var C=h?h/y:l/x,M=T>=150?r(b,C):c(b,C);E={canvas:M,src:M.toDataURL(u,d)}}else E={canvas:b,src:b.toDataURL(u,d)};return E.blob=i(E.src),E.url=window.URL.createObjectURL(E.blob),E},load:function(t){var e=this;e.show(),e.pinch&&e.pinch.remove(),e.options.target=t,e.initPinch()},show:function(){this.root.el.style.display="block"},hide:function(){this.root.el.style.display="none"},destroy:function(){var t=this;t.pinch.remove(),m(t.root,t.options.el)},moveTo:function(t,e){this.pinch.moveTo(t,e)},scaleTo:function(t,e){this.pinch.scaleTo(t,e)}},L.count=0,L.loadImage=d,L.Pinch=N,L});
