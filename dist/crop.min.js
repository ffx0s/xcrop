!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Crop=e()}(this,function(){"use strict";function t(){}function e(t,e){function n(n){var i=arguments.length;return i?i>1?t.apply(e,arguments):t.call(e,n):t.call(e)}return n._length=t.length,n}function n(t,e){for(var n in e)t[n]=e[n];return t}function i(t){var e=void 0;e=t.split(",")[0].indexOf("base64")>=0?window.atob(t.split(",")[1]):unescape(t.split(",")[1]);for(var n=t.split(",")[0].split(":")[1].split(";")[0],i=new ArrayBuffer(e.length),o=new Uint8Array(i),a=0;a<e.length;a++)o[a]=e.charCodeAt(a);var r=void 0;try{r=new window.Blob([i],{type:n})}catch(t){if(window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,"TypeError"===t.name&&window.BlobBuilder){var c=new window.BlobBuilder;c.append(o.buffer),r=c.getBlob(n)}else"InvalidStateError"===t.name&&(r=new window.Blob([i],{type:n}))}return r}function o(t,e){var n=new window.XMLHttpRequest;n.open("GET",t,!0),n.responseType="blob",n.onload=function(t){200!==this.status&&0!==this.status||e(this.response)},n.send()}function a(t,e){var n=new window.XMLHttpRequest;n.onload=function(){if(200!==this.status&&0!==this.status)throw new Error("Could not load image");e(n.response),n=null},n.open("GET",t,!0),n.responseType="arraybuffer",n.send(null)}function r(t,e){var n=document.createElement("canvas"),i=n.getContext("2d"),o=t.width,a=t.height;return n.width=o*e,n.height=a*e,i.drawImage(t,0,0,o,a,0,0,n.width,n.height),n}function c(t,e){var n=document.createElement("canvas"),i=n.getContext("2d"),o=t.getContext("2d"),a=t.width,r=t.height,c=a*e,s=r*e;n.width=c,n.height=s;for(var h=Math.ceil(Math.log(a/c)/Math.log(2)),l=0;l<h;l++)o.drawImage(t,0,0,.5*a,.5*r);return i.drawImage(t,0,0,t.width*Math.pow(.5,h),t.height*Math.pow(.5,h),0,0,c,s),n}function s(t){var e=new DataView(t);if(65496!==e.getUint16(0,!1))return-2;for(var n=e.byteLength,i=2;i<n;){var o=e.getUint16(i,!1);if(i+=2,65505===o){if(1165519206!==e.getUint32(i+=2,!1))return-1;var a=18761===e.getUint16(i+=6,!1);i+=e.getUint32(i+4,a);var r=e.getUint16(i,a);i+=2;for(var c=0;c<r;c++)if(274===e.getUint16(i+12*c,a))return e.getUint16(i+12*c+8,a)}else{if(65280!=(65280&o))break;i+=e.getUint16(i,!1)}}return-1}function h(t,e,n,i){var o=t.naturalWidth,a=t.naturalHeight;if(o+a){var r=n.width,c=n.height,s=e.getContext("2d");s.save(),d(e,s,r,c,n.orientation);l(t)&&(o/=2,a/=2);var h=1024,f=document.createElement("canvas");f.width=f.height=h;for(var v=f.getContext("2d"),m=i?u(t,o,a):1,g=Math.ceil(h*r/o),p=Math.ceil(h*c/a/m),w=0,y=0;w<a;){for(var x=0,b=0;x<o;)v.clearRect(0,0,h,h),v.drawImage(t,-x,-w),s.drawImage(f,0,0,h,h,b,y,g,p),x+=h,b+=g;w+=h,y+=p}s.restore(),f=v=null}}function l(t){var e=t.naturalWidth;if(e*t.naturalHeight>1048576){var n=document.createElement("canvas");n.width=n.height=1;var i=n.getContext("2d");return i.drawImage(t,1-e,0),0===i.getImageData(0,0,1,1).data[3]}return!1}function u(t,e,n){var i=document.createElement("canvas");i.width=1,i.height=n;var o=i.getContext("2d");o.drawImage(t,0,0);for(var a=o.getImageData(0,0,1,n).data,r=0,c=n,s=n;s>r;){0===a[4*(s-1)+3]?c=s:r=s,s=c+r>>1}var h=s/n;return 0===h?1:h}function d(t,e,n,i,o){switch([5,6,7,8].indexOf(o)>-1?(t.width=i,t.height=n):(t.width=n,t.height=i),o){case 2:e.transform(-1,0,0,1,n,0);break;case 3:e.transform(-1,0,0,-1,n,i);break;case 4:e.transform(1,0,0,-1,0,i);break;case 5:e.transform(0,1,1,0,0,0);break;case 6:e.transform(0,1,-1,0,i,0);break;case 7:e.transform(0,-1,-1,0,i,n);break;case 8:e.transform(0,-1,1,0,0,n);break;default:e.transform(1,0,0,1,0,0)}}function f(t,e,n,i){var o=t/e,a=n,r=a/o,c=0,s=-(r-i)/2;return r<i&&(r=i,a=o*r,c=-(a-n)/2,s=0),{width:a,height:r,x:c,y:s}}function v(t,e,r){function c(t,n){var i=s(t),o="string"!=typeof n,a=o?H.createObjectURL(n):n,r=o&&"image/jpeg"===n.type,c=new window.Image;O(a)||(c.crossOrigin="*"),c.onload=function(){m(c,i,e,r,l),o&&H.revokeObjectURL(a)},c.src=a}function h(t){var e=new window.FileReader;e.onload=function(e){c(e.target.result,t)},e.readAsArrayBuffer(t)}var l=n({maxWidth:2e3,maxHeight:2e3},r);return window.FileReader&&(t instanceof window.Blob||t instanceof window.File)?void h(t):"object"===(void 0===t?"undefined":W(t))&&t.nodeType?("IMG"===t.tagName&&v(t.src,e),void("CANVAS"===t.tagName&&e(t))):O(t)?void h(i(t)):void(I(t)?o(t,h):a(t,function(e){c(e,t)}))}function m(t,e,n,i,o){var a=document.createElement("canvas"),r=o.maxWidth,c=o.maxHeight,s=o.width,l=o.height,u=t.naturalWidth,d=t.naturalHeight;s&&!l?l=d*s/u<<0:l&&!s?s=u*l/d<<0:(s=u,l=d),r&&u>r&&(s=r,l=d*s/u<<0),c&&l>c&&(l=c,s=u*l/d<<0),h(t,a,{orientation:e,width:s,height:l},i),n(a)}function g(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];for(var i in e)this[i]=e[i];this.tagName=t,this.children=n}function p(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t;if("string"==typeof e){var i=document.createTextNode(e);return n(e),i}var o=e.create();return e.children.forEach(function(t){var e=p(t,n);o.appendChild(e)}),n(e),o}function w(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];"string"!=typeof t&&(t.children.forEach(function(t){w(t,e,!1)}),t.removeEvent(),n&&e.removeChild(t.el))}function y(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document.getElementsByTagName("head")[0],n=document.createElement("style");try{n.appendChild(document.createTextNode(t))}catch(e){n.stylesheet.cssText=t}return e.appendChild(n),n}function x(){this.events={}}function b(t,e){var n=[];for(var i in t)"number"!=typeof+i||isNaN(+i)||n.push(e(t[i],i));return n}function S(t){t.eventList=["mousewheel","touchstart","touchmove","touchend"],t.isMove=!1,t.isLock=!1,t.observer=new x}function T(t){var e=t.options.touchTarget||t.canvas;t.eventList.forEach(function(n){e.addEventListener(n,t,!1)})}function E(t){t.scale=1,t.lastScale=1,t.origin={x:0,y:0}}function C(t){var e=t.options;e.el="string"==typeof e.el?document.querySelector(e.el):e.el,t.canvas=t.createCanvas(),t.context=t.canvas.getContext("2d"),function(n){var i=t.createCanvas();e.el.appendChild(i),setTimeout(function(){var t=i.getBoundingClientRect();e.el.removeChild(i),i=null,n(t)},10)}(function(n){t.rect=n,t.canvasScale=e.width/t.rect.width,t.load(e.target,function(){e.el.appendChild(t.canvas)})})}function k(t,e){return t+e}function M(t){return{x:t.map(function(t){return t.x}).reduce(k)/t.length,y:t.map(function(t){return t.y}).reduce(k)/t.length}}function L(t,e,n){n=n||["x","y"];var i=e[n[0]]-t[n[0]],o=e[n[1]]-t[n[1]];return Math.sqrt(i*i+o*o)}function N(t,e){return L(e[0],e[1])/L(t[0],t[1])}function R(){return{target:null,maxTargetWidth:2e3,maxTargetHeight:2e3,el:null,width:800,height:800,maxScale:2,minScale:1,touchTarget:null,offset:{left:0,right:0,top:0,bottom:0},loaded:t}}function U(t,e){e.el=t,this.init(e)}function B(){return{target:null,maxTargetWidth:2e3,maxTargetHeight:2e3,el:null,width:300,height:300,x:void 0,y:void 0,maxScale:2,minScale:1,canvasScale:2,touchTarget:null,created:t,mounted:t,loaded:t,cancle:t,confirm:t}}function A(t){this.init(t)}function z(t){return"crop-"+t}var H=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null,I=function(t){return/^blob:/i.test(t)},W="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},O=function(t){return t.indexOf(";base64,")>0};g.prototype={create:function(){return this.el=document.createElement(this.tagName),this.el.className=this.className,this.addEvent(),this.el}},["addEvent","removeEvent"].forEach(function(t){g.prototype[t]=function(){for(var e in this.events)this.el[t+"Listener"](e,this.events[e],!1)}});var q=Array.prototype.slice;x.prototype={on:function(t,e){var n=this;t.split(" ").forEach(function(t){n.events[t]||(n.events[t]=[]),e&&n.events[t].push(e)})},emit:function(t){var e=this,n=q.call(arguments,1);t=t.split(" ").forEach(function(t){var i=e.events[t];i&&i.forEach(function(t){return t.apply(e,n)})})},off:function(t,e){var n=this,i=n.events[t];i&&i.forEach(function(t){return i.splice(i.indexOf(t),1)})}};var j={easeOut:function(t,e,n,i){return-n*(t/=i)*(t-2)+e}},D=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)}}(),F=function(){return window.cancelAnimationFrame||window.mozCancelAnimationFrame||function(t){clearTimeout(t)}}(),X=function(){return(new Date).getTime()},Y=function(t){function e(){var t=X(),n=1-Math.max(0,h-t+i)/i,o=[];r.forEach(function(t){o.push(j[a](n*i,t[0],t[1]-t[0],i))}),c(o),1===n?(F(c.timer),s&&s()):D(e)}var n=t.times,i=void 0===n?500:n,o=t.type,a=void 0===o?"easeOut":o,r=t.targets,c=t.animate,s=t.end,h=X();F(c.timer),c.timer=D(e)};return U.prototype.init=function(t){var e=this;e.options=n(R(),t),function(t){S(t),E(t)}(e),C(e),T(e)},function(t){t.getTouchCenter=M,t.getDistance=L,t.getScale=N,t.Observer=x}(U),function(t){var n=t.prototype;n.handleEvent=function(t){var e=this;switch(t.type){case"touchstart":e.touchstart(t);break;case"touchmove":e.touchmove(t);break;case"touchend":e.touchend(t);break;case"mousewheel":e.mousewheel(t)}},n.mousewheel=function(t){t.preventDefault();var e=this,n={x:t.clientX-e.rect.left,y:t.clientY-e.rect.top},i=t.wheelDelta/520,o=Math.exp(.01*i);e.scaleTo(n,o),e.validation(),e.emit("mousewheel",t)},n.touchstart=function(t){t.preventDefault();var e=this,n=t.touches;if(e.isLock)return!1;2===n.length?e.pinchstart(t):1===n.length&&e.dragstart(t),e.isMove=!0},n.touchmove=function(t){var e=this,n=t.touches;if(!e.isMove||e.isLock)return!1;2===n.length?e.pinchmove(t):1===n.length&&e.dragmove(t)},n.touchend=function(t){var e=this;if(e.isLock)return!1;e.isMove=!1,e.validation(),e.emit("touchend",t)},n.dragstart=function(t){var e=this,n=t.touches;e.dragStart={x:n[0].pageX-e.rect.left,y:n[0].pageY-e.rect.top},e.lastMove={x:e.position.x-e.origin.x,y:e.position.y-e.origin.y},e.emit("touchstart",t)},n.dragmove=function(t){var e=this,n=t.touches,i={x:n[0].pageX-e.rect.left-e.dragStart.x,y:n[0].pageY-e.rect.top-e.dragStart.y},o=e.canvasScale/e.scale,a=e.lastMove.x+i.x*o,r=e.lastMove.y+i.y*o;e.moveTo(a,r),e.emit("touchmove",t)},n.pinchstart=function(t){var e=this;e.zoomStart=b(t.touches,function(t){return{x:t.pageX,y:t.pageY}}),e.zoomCount=0,e.emit("pinchstart",t)},n.pinchmove=function(e){var n=this;if(!n.isMove)return!1;n.zoomCount++,n.zoomEnd=b(e.touches,function(t){return{x:t.pageX,y:t.pageY}});var i=t.getTouchCenter(n.zoomEnd),o=t.getScale(n.zoomStart,n.zoomEnd);if(n.zoomCount<=2)return n.lastScale=o,!1;var a=1+o-n.lastScale,r={x:i.x-n.rect.left,y:i.y-n.rect.top};n.scaleTo(r,a),n.lastScale=o,n.emit("pinchmove",e)},n.emit=function(t){this.observer.emit.apply(this.observer,arguments)},["on","off"].forEach(function(t){n[t]=function(n,i){this.observer[t](n,i&&e(i,this))}})}(U),function(t){var e=t.prototype;e.createCanvas=function(){var t=this,e=document.createElement("canvas");return e.width=t.options.width,e.height=t.options.height,e.style.cssText="width:100%;height:100%;",e},e.load=function(t,e){function n(t){var n=i.options,o=n.width,a=n.height,r=n.offset,c=n.loaded,s=i.canvasScale,h=o-(r.left+r.right)*s,l=a-(r.top+r.bottom)*s;i.position=f(t.width,t.height,h,l),i.position.x+=r.left*s,i.position.y+=r.top*s,i.imageCanvas=t,i.draw(),e&&e(),c.call(i)}var i=this;v(t,n,{maxWidth:i.options.maxTargetWidth,maxHeight:i.options.maxTargetHeight})},e.remove=function(){var t=this,e=t.options.touchTarget||t.canvas;t.eventList.forEach(function(n){e.removeEventListener(n,t,!1)}),t.options.el.removeChild(t.canvas)},e.draw=function(){var t=this,e=t.options,n=t.context,i=t.position,o=i.x,a=i.y,r=i.width,c=i.height;n.save(),n.setTransform(1,0,0,1,0,0),n.clearRect(0,0,e.width,e.height),n.restore(),n.drawImage(t.imageCanvas,o,a,r,c)},e.moveTo=function(t,e){var n=this,i=t-(n.position.x-n.origin.x),o=e-(n.position.y-n.origin.y);n.context.translate(i,o),n.origin.x-=i,n.origin.y-=o,n.draw()},e.scaleTo=function(t,e){var n=this,i=n.context,o=n.canvasScale,a=n.scale,r=n.origin;if(e>1&&!n.vaildMaxScale()||e<1&&!n.vaildMinScale())return!1;n.vaildMaxScale(a*e)?n.vaildMinScale(a*e)||(e=n.options.minScale/a):e=n.options.maxScale/a,i.translate(r.x,r.y),n.origin.x-=t.x*o/(a*e)-t.x*o/a,n.origin.y-=t.y*o/(a*e)-t.y*o/a,i.scale(e,e),i.translate(-n.origin.x,-n.origin.y),n.scale*=e,n.draw()}}(U),function(t){var n=t.prototype;n.validation=function(){function t(){n.lastAnimate={x:0,y:0}}var n=this,i=n.options,o=n.position,a=n.scale,r=(o.x-n.origin.x)*a,c=(o.y-n.origin.y)*a,s=i.offset,h=s.left,l=s.right,u=s.top,d=s.bottom,f=n.canvasScale,v=h*f,m=u*f,g=i.width-(h+l)*f-(o.width*a-(v-r)),p=i.height-(u+d)*f-(o.height*a-(m-c)),w=0,y=0,x=!1;r>=v?(w=-(r-v)/a,n.origin.x-=w,x=!0):g>0&&(w=g/a,n.origin.x-=w,x=!0),c>=m?(y=-(c-m)/a,n.origin.y-=y,x=!0):p>0&&(y=p/a,n.origin.y-=y,x=!0),x&&(t(),Y({targets:[[0,w],[0,y]],times:150,animate:e(n._animate,n),end:function(){n.isLock=!1,t()}}))},n.vaildMaxScale=function(t){return(t||this.scale)<this.options.maxScale},n.vaildMinScale=function(t){return(t||this.scale)>this.options.minScale},n._animate=function(t){var e=this,n=e.lastAnimate;e.isLock=!0,e.context.translate(t[0]-n.x,t[1]-n.y),e.draw(),e.lastAnimate={x:t[0],y:t[1]}}}(U),A.prototype={init:function(t){var e=this;e.options=n(B(),t),e.create(),e.render(),A.count++},create:function(){var t=this,n=t.options,i=n.el;n.el=i?"string"==typeof i?document.querySelector(i):i:document.body;var o=[],a=n.width,r=n.height,c=document.documentElement,s={className:z("wrap"),width:i&&i.offsetWidth?i.offsetWidth:c.clientWidth,height:i&&i.offsetHeight?i.offsetHeight:c.clientHeight,style:function(){return"\n          ."+this.className+" {\n            position: fixed;\n            left: 0;\n            top: 0;\n            overflow: hidden;\n            width: "+this.width+"px;\n            height: "+this.height+"px;\n            background: #000;\n            z-index: 99;\n          }\n        "}},h={className:z("mask"),left:"number"==typeof n.x?n.x-s.width:-(a+s.width)/2,top:"number"==typeof n.y?n.y-s.height:-(r+s.height)/2,style:function(){return"\n          ."+this.className+" {\n            position: absolute; \n            left: "+this.left+"px;\n            top: "+this.top+"px;\n            width: "+a+"px; \n            height: "+r+"px; \n            overflow: hidden;\n            border: 1px solid rgba(0, 0, 0, .6);\n            border-width: "+s.height+"px "+s.width+"px;\n            box-sizing: content-box;\n          }\n          ."+this.className+":after {\n            position: absolute;\n            left: 0;\n            top: 0;\n            float: left;\n            content: '';\n            width: 200%;\n            height: 200%;\n            border: 1px solid #fff;\n            -webkit-box-sizing: border-box;\n            box-sizing: border-box;\n            -webkit-transform: scale(0.5);\n            transform: scale(0.5);\n            -webkit-transform-origin: 0 0;\n            transform-origin: 0 0;\n          }\n        "}},l={className:z("handle"),style:function(){return"\n          ."+this.className+" {\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            width: 100%;\n            height: 50px;\n            line-height: 50px;\n            background-color: rgba(0,0,0,.3);\n          }\n          ."+this.className+" > div {\n            height: 100px;\n            width: 80px;\n            color: #fff;\n            font-size: 16px;\n            text-align: center;\n          }\n        "}},u={className:z("cancle"),style:function(){return"\n          ."+this.className+" {\n            float: left;\n          }\n        "},events:{touchstart:e(n.cancle,t)}},d={className:z("confirm"),style:function(){return"\n          ."+this.className+" {\n            float: right;\n          }\n        "},events:{touchstart:e(n.confirm,t)}};t.root=new g("div",s,[new g("div",h),new g("div",l,[new g("div",u,["取消"]),new g("div",d,["确认"])])]),p(t.root,function(t){t.style&&o.push(t.style())}),t.styles=o.join(""),t.area={width:a,height:r},n.x=s.width+h.left,n.y=s.height+h.top,n.created.call(t)},render:function(){var t=this,n=t.options;0===A.count&&y(t.styles),n.el.appendChild(t.root.el),t.initPinch(),setTimeout(e(n.mounted,t),0)},initPinch:function(){function t(){var t=e.options,n=t.target,i=t.maxTargetWidth,o=t.maxTargetHeight,a=t.canvasScale,r=t.x,c=t.y,s=t.el,h=t.maxScale,l=t.minScale,u=t.loaded,d=e.root,f=d.el,v=d.width,m=d.height,g={target:n,maxTargetWidth:i,maxTargetHeight:o,el:s,maxScale:h,minScale:l,loaded:u,width:v*a,height:m*a,touchTarget:f,offset:{left:r,right:v-e.area.width-r,top:c,bottom:m-e.area.height-c}};e.pinch=new U(f,g)}var e=this;setTimeout(t,0)},get:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=this,o=e.pinch,a={width:void 0,height:void 0,type:"image/jpeg",quality:.85},s=n(a,t),h=s.width,l=s.height,u=s.type,d=s.quality,f=o.options.offset,v=f.left,m=f.top,g=o.options.width/o.rect.width,p=v*g,w=m*g,y=e.area.width*g,x=e.area.height*g,b=document.createElement("canvas"),S=b.getContext("2d");b.width=y,b.height=x,S.drawImage(o.canvas,p,w,y,x,0,0,y,x);var T={},E=h||l;if(E){var C=h?h/y:l/x,k=E>=150?r(b,C):c(b,C);T={canvas:k,src:k.toDataURL(u,d)}}else T={canvas:b,src:b.toDataURL(u,d)};return T.blob=i(T.src),T.url=H.createObjectURL(T.blob),T},load:function(t){var e=this;e.show(),e.pinch&&e.pinch.remove(),e.options.target=t,e.initPinch()},show:function(){this.root.el.style.display="block"},hide:function(){this.root.el.style.display="none"},destroy:function(){var t=this;t.pinch.remove(),w(t.root,t.options.el)},moveTo:function(t,e){this.pinch.moveTo(t,e)},scaleTo:function(t,e){this.pinch.scaleTo(t,e)}},A.count=0,A.loadImage=v,A.Pinch=U,A});
